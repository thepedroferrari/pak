---
// Script-only component â€” renders no HTML, just client-side animation logic.
// Imported at the bottom of lineage pages to layer GSAP animations on top of static content.
---

<script>
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  if (!prefersReducedMotion) {
    // --- Initial states (set via GSAP, not CSS, for progressive enhancement) ---
    gsap.set('[data-gsap="text"]', { opacity: 0, y: 30 });
    gsap.set('[data-gsap="tier"]', { opacity: 0 });
    gsap.set('[data-gsap="photo"]', { opacity: 0, scale: 0 });
    gsap.set('[data-gsap="connector"]', { opacity: 0, scaleY: 0, transformOrigin: 'top center' });
    gsap.set('[data-gsap="label"]', { opacity: 0, y: 20 });
    gsap.set('[data-gsap="card"]', { opacity: 0, y: 40, scale: 0.9 });

    // Hide fork SVG lines for draw-in animation (pathLength="1" on each line)
    const forkLines = document.querySelectorAll('[data-gsap="fork"] line');
    forkLines.forEach((line) => {
      line.style.strokeDasharray = '1';
      line.style.strokeDashoffset = '1';
    });

    // --- Text blocks: fade in + slide up ---
    document.querySelectorAll('[data-gsap="text"]').forEach((el) => {
      gsap.to(el, {
        opacity: 1,
        y: 0,
        duration: 0.8,
        ease: 'power2.out',
        scrollTrigger: {
          trigger: el,
          start: 'top 90%',
          toggleActions: 'play none none none',
        },
      });
    });

    // --- Tiers: container fades in, then photo bounces ---
    document.querySelectorAll('[data-gsap="tier"]').forEach((tier) => {
      const photo = tier.querySelector('[data-gsap="photo"]');
      const tl = gsap.timeline({
        scrollTrigger: {
          trigger: tier,
          start: 'top 85%',
          toggleActions: 'play none none none',
        },
      });

      tl.to(tier, {
        opacity: 1,
        duration: 0.3,
        ease: 'power2.out',
      });

      if (photo) {
        tl.to(photo, {
          opacity: 1,
          scale: 1,
          duration: 0.6,
          ease: 'back.out(1.7)',
        }, '-=0.1');
      }
    });

    // --- Simple connectors: grow downward ---
    document.querySelectorAll('[data-gsap="connector"]').forEach((conn) => {
      gsap.to(conn, {
        opacity: 1,
        scaleY: 1,
        duration: 0.4,
        ease: 'power2.inOut',
        scrollTrigger: {
          trigger: conn,
          start: 'top 88%',
          toggleActions: 'play none none none',
        },
      });
    });

    // --- Fork connectors: SVG lines draw in sequentially ---
    document.querySelectorAll('[data-gsap="fork"]').forEach((fork) => {
      const lines = fork.querySelectorAll('line');
      if (lines.length === 0) return;

      gsap.to(lines, {
        strokeDashoffset: 0,
        duration: 0.4,
        stagger: 0.08,
        ease: 'power2.inOut',
        scrollTrigger: {
          trigger: fork,
          start: 'top 85%',
          toggleActions: 'play none none none',
        },
      });
    });

    // --- Labels: fade + slide up ---
    document.querySelectorAll('[data-gsap="label"]').forEach((label) => {
      gsap.to(label, {
        opacity: 1,
        y: 0,
        duration: 0.5,
        ease: 'power2.out',
        scrollTrigger: {
          trigger: label,
          start: 'top 88%',
          toggleActions: 'play none none none',
        },
      });
    });

    // --- Grid cards: stagger in left to right with bounce ---
    document.querySelectorAll('[data-gsap="grid"]').forEach((grid) => {
      const cards = grid.querySelectorAll('[data-gsap="card"]');
      if (cards.length === 0) return;

      gsap.to(cards, {
        opacity: 1,
        y: 0,
        scale: 1,
        duration: 0.5,
        ease: 'back.out(1.4)',
        stagger: 0.12,
        scrollTrigger: {
          trigger: grid,
          start: 'top 85%',
          toggleActions: 'play none none none',
        },
      });
    });
  }
</script>
