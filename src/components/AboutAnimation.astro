---
// Script-only component — renders no HTML, just client-side animation logic.
// Imported at the bottom of about pages to layer GSAP animations on top of static content.
---

<script>
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  // Reusable ember glow values
  const EMBER_PEAK = '0 0 30px rgba(196, 30, 58, 0.9), 0 0 60px rgba(139, 0, 0, 0.6), 0 0 15px rgba(212, 175, 55, 0.7), 0 0 100px rgba(196, 30, 58, 0.3)';
  const EMBER_WARM = '0 0 12px rgba(212, 175, 55, 0.3), 0 0 30px rgba(196, 30, 58, 0.12), 0 0 4px rgba(212, 175, 55, 0.15)';
  const EMBER_NONE = '0 0 0px transparent';
  const EMBER_INTENSE = '0 0 50px rgba(196, 30, 58, 1), 0 0 100px rgba(139, 0, 0, 0.7), 0 0 25px rgba(212, 175, 55, 0.8), 0 0 150px rgba(196, 30, 58, 0.4), 0 0 200px rgba(139, 0, 0, 0.15)';

    // ─── Hero entrance (staggered + ember glow on title) ────────────
    gsap.set('[data-gsap="hero-zh"]', { opacity: 0, scale: 0.8, textShadow: EMBER_NONE });
    gsap.set('[data-gsap="hero-line"]', { opacity: 0, y: -20 });
    gsap.set('[data-gsap="hero-title"]', { opacity: 0, y: 30, textShadow: EMBER_NONE });
    gsap.set('[data-gsap="hero-divider"]', { opacity: 0, scaleX: 0 });
    gsap.set('[data-gsap="hero-subtitle"]', { opacity: 0, y: 20, textShadow: EMBER_NONE });
    gsap.set('[data-gsap="hero-desc"]', { opacity: 0, y: 20 });

    const heroTl = gsap.timeline({ delay: 0.2 });
    heroTl
      // Watermark burns in with red smolder
      .to('[data-gsap="hero-zh"]', { opacity: 1, scale: 1, duration: 1.2, ease: 'power2.out' })
      .to('[data-gsap="hero-zh"]', {
        textShadow: '0 0 60px rgba(196, 30, 58, 0.4), 0 0 120px rgba(139, 0, 0, 0.2)',
        duration: 1.0, ease: 'power2.in',
      }, 0.2)
      .to('[data-gsap="hero-zh"]', {
        textShadow: '0 0 20px rgba(196, 30, 58, 0.08), 0 0 60px rgba(139, 0, 0, 0.04)',
        duration: 1.5, ease: 'power2.out',
      }, 1.2)

      // Decorative line
      .to('[data-gsap="hero-line"]', { opacity: 1, y: 0, duration: 0.5, ease: 'power2.out' }, 0.5)

      // Title burns in with ember flare
      .to('[data-gsap="hero-title"]', { opacity: 1, y: 0, duration: 0.8, ease: 'power3.out' }, 0.7)
      .to('[data-gsap="hero-title"]', {
        textShadow: EMBER_PEAK,
        duration: 0.6, ease: 'power2.in',
      }, 0.8)
      .to('[data-gsap="hero-title"]', {
        textShadow: EMBER_WARM,
        duration: 1.2, ease: 'power2.out',
      }, 1.4)

      // Divider
      .to('[data-gsap="hero-divider"]', { opacity: 1, scaleX: 1, duration: 0.6, ease: 'power2.out' }, 1.1)

      // Subtitle with warm glow
      .to('[data-gsap="hero-subtitle"]', { opacity: 1, y: 0, duration: 0.6, ease: 'power2.out' }, 1.3)
      .to('[data-gsap="hero-subtitle"]', {
        textShadow: '0 0 20px rgba(212, 175, 55, 0.4), 0 0 40px rgba(212, 175, 55, 0.15)',
        duration: 0.8, ease: 'power2.out',
      }, 1.4)

      // Description
      .to('[data-gsap="hero-desc"]', { opacity: 1, y: 0, duration: 0.6, ease: 'power2.out' }, 1.5);

    // Hero parallax background
    const heroBg = document.querySelector('[data-gsap="hero-bg"]');
    if (heroBg) {
      gsap.to(heroBg, {
        yPercent: 20,
        ease: 'none',
        scrollTrigger: {
          trigger: heroBg.closest('section'),
          start: 'top top',
          end: 'bottom top',
          scrub: true,
        },
      });
    }

    // Scroll indicator bounce
    const scrollDot = document.querySelector('[data-gsap="scroll-indicator"]');
    if (scrollDot) {
      gsap.to(scrollDot, {
        y: 8,
        duration: 1.2,
        ease: 'power1.inOut',
        repeat: -1,
        yoyo: true,
      });
    }

    // ─── Section Chinese headings — burning reveal ──────────────────
    document.querySelectorAll('[data-gsap="section-zh"]').forEach((el) => {
      gsap.set(el, {
        clipPath: 'inset(100% 0 0 0)',
        textShadow: EMBER_NONE,
        opacity: 1,
      });

      const tl = gsap.timeline({
        scrollTrigger: {
          trigger: el,
          start: 'top 90%',
          toggleActions: 'play none none none',
        },
      });

      // Burn in top-to-bottom
      tl.to(el, {
        clipPath: 'inset(0% 0 0 0)',
        duration: 1.0,
        ease: 'power1.inOut',
      }, 0);

      // Ember flare during reveal
      tl.to(el, {
        textShadow: '0 0 25px rgba(196, 30, 58, 0.7), 0 0 50px rgba(139, 0, 0, 0.4), 0 0 12px rgba(212, 175, 55, 0.5)',
        duration: 0.5,
        ease: 'power2.in',
      }, 0.2);

      // Settle to warm ambient
      tl.to(el, {
        textShadow: '0 0 8px rgba(212, 175, 55, 0.15), 0 0 20px rgba(196, 30, 58, 0.06)',
        duration: 0.8,
        ease: 'power2.out',
      }, 0.7);
    });

    // ─── Founder section ────────────────────────────────────────────
    gsap.set('[data-gsap="founder-img"]', { opacity: 0, x: -60 });
    gsap.set('[data-gsap="founder-text"]', { opacity: 0, x: 60 });
    gsap.set('[data-gsap="founder-quote"]', { opacity: 0, y: 30 });

    const founderImg = document.querySelector('[data-gsap="founder-img"]');
    if (founderImg) {
      const founderSection = founderImg.closest('section');
      const founderTl = gsap.timeline({
        scrollTrigger: {
          trigger: founderSection,
          start: 'top 80%',
          toggleActions: 'play none none none',
        },
      });
      founderTl
        .to('[data-gsap="founder-img"]', { opacity: 1, x: 0, duration: 0.8, ease: 'power2.out' })
        .to('[data-gsap="founder-text"]', { opacity: 1, x: 0, duration: 0.8, ease: 'power2.out' }, '-=0.5');
    }

    // Quote — warm border glow on enter
    const founderQuote = document.querySelector('[data-gsap="founder-quote"]');
    if (founderQuote) {
      gsap.set(founderQuote, { boxShadow: 'inset 4px 0 8px -2px transparent' });
      const quoteTl = gsap.timeline({
        scrollTrigger: {
          trigger: founderQuote,
          start: 'top 88%',
          toggleActions: 'play none none none',
        },
      });
      quoteTl
        .to(founderQuote, { opacity: 1, y: 0, duration: 0.7, ease: 'power2.out' }, 0)
        // Warm fire glow on left border
        .to(founderQuote, {
          boxShadow: 'inset 4px 0 16px -2px rgba(196, 30, 58, 0.5), 0 0 30px rgba(212, 175, 55, 0.08)',
          duration: 0.6, ease: 'power2.in',
        }, 0.3)
        .to(founderQuote, {
          boxShadow: 'inset 4px 0 10px -2px rgba(212, 175, 55, 0.15), 0 0 12px rgba(212, 175, 55, 0.04)',
          duration: 1.0, ease: 'power2.out',
        }, 0.9);
    }

    // ─── Timeline ───────────────────────────────────────────────────
    // Center line draws via scrub-linked scaleY
    const timelineLine = document.querySelector('[data-gsap="timeline-line"]');
    if (timelineLine) {
      gsap.set(timelineLine, { scaleY: 0, transformOrigin: 'top center' });
      gsap.to(timelineLine, {
        scaleY: 1,
        ease: 'none',
        scrollTrigger: {
          trigger: '[data-gsap="timeline-section"]',
          start: 'top 80%',
          end: 'bottom 20%',
          scrub: 0.5,
        },
      });
    }

    // Milestones slide from alternating sides
    document.querySelectorAll<HTMLElement>('[data-gsap="timeline-milestone"]').forEach((el) => {
      const side = el.getAttribute('data-side');
      const isHighlight = el.querySelector('.animate-ping') !== null;
      const fromX = side === 'left' ? -60 : 60;

      gsap.set(el, { opacity: 0, x: fromX });

      const tl = gsap.timeline({
        scrollTrigger: {
          trigger: el,
          start: 'top 85%',
          toggleActions: 'play none none none',
        },
      });

      tl.to(el, { opacity: 1, x: 0, duration: 0.8, ease: 'power2.out' }, 0);

      // Highlight milestones (1984, 2024) get a warm gold flare
      if (isHighlight) {
        const card = el.querySelector('.relative.p-6');
        if (card) {
          tl.to(card, {
            boxShadow: '0 0 30px rgba(212, 175, 55, 0.3), 0 0 60px rgba(196, 30, 58, 0.15), inset 0 0 20px rgba(212, 175, 55, 0.05)',
            duration: 0.6, ease: 'power2.in',
          }, 0.3);
          tl.to(card, {
            boxShadow: '0 0 15px rgba(212, 175, 55, 0.1), 0 0 30px rgba(196, 30, 58, 0.05)',
            duration: 1.2, ease: 'power2.out',
          }, 0.9);
        }
      }
    });

    // Timeline dots bounce in with back.out(2)
    document.querySelectorAll('[data-gsap="timeline-dot"]').forEach((el) => {
      gsap.set(el, { scale: 0 });
      gsap.to(el, {
        scale: 1,
        duration: 0.5,
        ease: 'back.out(2)',
        scrollTrigger: {
          trigger: el,
          start: 'top 85%',
          toggleActions: 'play none none none',
        },
      });
    });

    // ─── Chan Memorial ──────────────────────────────────────────────
    const memorialSection = document.querySelector('[data-gsap="memorial-section"]');
    if (memorialSection) {
      gsap.set('[data-gsap="memorial-photo"]', { opacity: 0, scale: 0.8 });
      gsap.set('[data-gsap="memorial-text"]', { opacity: 0, x: 40 });

      const memTl = gsap.timeline({
        scrollTrigger: {
          trigger: memorialSection,
          start: 'top 75%',
          toggleActions: 'play none none none',
        },
      });
      memTl
        .to('[data-gsap="memorial-photo"]', { opacity: 1, scale: 1, duration: 0.8, ease: 'power2.out' })
        .to('[data-gsap="memorial-text"]', { opacity: 1, x: 0, duration: 0.8, ease: 'power2.out' }, '-=0.4');
    }

    // ─── Gallery strips — infinite horizontal scroll ────────────────
    function createInfiniteScroll(selector: string, reverse: boolean) {
      const row = document.querySelector(selector);
      if (!row) return null;

      if (reverse) {
        gsap.set(row, { xPercent: -50 });
        return gsap.to(row, {
          xPercent: 0,
          duration: 45,
          ease: 'none',
          repeat: -1,
        });
      }

      return gsap.to(row, {
        xPercent: -50,
        duration: 40,
        ease: 'none',
        repeat: -1,
      });
    }

    const loop1 = createInfiniteScroll('[data-gsap="gallery-row-1"]', false);
    const loop2 = createInfiniteScroll('[data-gsap="gallery-row-2"]', true);

    // Pause on hover (slow timeScale), resume on leave
    const galleryStrip = document.querySelector('[data-gsap="gallery-strip"]');
    if (galleryStrip && (loop1 || loop2)) {
      galleryStrip.addEventListener('mouseenter', () => {
        if (loop1) gsap.to(loop1, { timeScale: 0.2, duration: 0.8 });
        if (loop2) gsap.to(loop2, { timeScale: 0.2, duration: 0.8 });
      });
      galleryStrip.addEventListener('mouseleave', () => {
        if (loop1) gsap.to(loop1, { timeScale: 1, duration: 0.8 });
        if (loop2) gsap.to(loop2, { timeScale: 1, duration: 0.8 });
      });
    }

    // ─── Competition stats — stagger with back.out bounce ───────────
    gsap.set('[data-gsap="stat-card"]', { opacity: 0, y: 30, scale: 0.9 });
    document.querySelectorAll('[data-gsap="stat-grid"]').forEach((grid) => {
      const cards = grid.querySelectorAll('[data-gsap="stat-card"]');
      if (cards.length === 0) return;
      gsap.to(cards, {
        opacity: 1,
        y: 0,
        scale: 1,
        duration: 0.6,
        ease: 'back.out(1.7)',
        stagger: 0.1,
        scrollTrigger: {
          trigger: grid,
          start: 'top 85%',
          toggleActions: 'play none none none',
        },
      });
    });

    // Competition images — stagger scale-in
    gsap.set('[data-gsap="comp-img"]', { opacity: 0, scale: 0.85 });
    document.querySelectorAll('[data-gsap="comp-grid"]').forEach((grid) => {
      const imgs = grid.querySelectorAll('[data-gsap="comp-img"]');
      if (imgs.length === 0) return;
      gsap.to(imgs, {
        opacity: 1,
        scale: 1,
        duration: 0.6,
        ease: 'power2.out',
        stagger: 0.12,
        scrollTrigger: {
          trigger: grid,
          start: 'top 85%',
          toggleActions: 'play none none none',
        },
      });
    });

    // ─── Burning ideogram — 道 "The Way" (INTENSIFIED) ──────────────
    const ideogram = document.querySelector('[data-gsap="about-ideogram"]');
    const ideogramGlow = document.querySelector('[data-gsap="about-ideogram-glow"]');
    const missionText = document.querySelector('[data-gsap="mission-text"]');

    if (ideogram) {
      gsap.set(ideogram, {
        clipPath: 'inset(100% 0 0 0)',
        textShadow: EMBER_NONE,
      });
      if (ideogramGlow) gsap.set(ideogramGlow, { opacity: 0, scale: 0.3 });
      if (missionText) gsap.set(missionText, { opacity: 0, y: 30 });

      const missionSection = ideogram.closest('section');
      const ideoTl = gsap.timeline({
        scrollTrigger: {
          trigger: missionSection,
          start: 'top 70%',
          toggleActions: 'play none none none',
        },
      });

      // 1. Background glow expands — bigger and more red
      if (ideogramGlow) {
        ideoTl.to(ideogramGlow, {
          opacity: 0.9,
          scale: 1.2,
          duration: 1.4,
          ease: 'power2.out',
        }, 0);
      }

      // 2. Character burns in — clip-path top to bottom (slower for drama)
      ideoTl.to(ideogram, {
        clipPath: 'inset(0% 0 0 0)',
        duration: 2.0,
        ease: 'power1.inOut',
      }, 0.1);

      // 3. First ember wave — fierce red/orange
      ideoTl.to(ideogram, {
        textShadow: EMBER_INTENSE,
        duration: 0.8,
        ease: 'power2.in',
      }, 0.3);

      // 4. Brief cool-down then second flare (double-pulse effect)
      ideoTl.to(ideogram, {
        textShadow: '0 0 30px rgba(196, 30, 58, 0.5), 0 0 60px rgba(139, 0, 0, 0.3), 0 0 15px rgba(212, 175, 55, 0.4)',
        duration: 0.4,
        ease: 'power2.out',
      }, 1.1);
      ideoTl.to(ideogram, {
        textShadow: EMBER_INTENSE,
        duration: 0.5,
        ease: 'power2.in',
      }, 1.5);

      // 5. Settle to warm persistent glow
      ideoTl.to(ideogram, {
        textShadow: '0 0 20px rgba(212, 175, 55, 0.35), 0 0 50px rgba(196, 30, 58, 0.15), 0 0 8px rgba(212, 175, 55, 0.2)',
        duration: 1.2,
        ease: 'power2.out',
      }, 2.0);

      // 6. Background glow settles but stays warmer
      if (ideogramGlow) {
        ideoTl.to(ideogramGlow, {
          opacity: 0.35,
          scale: 1,
          duration: 1.2,
          ease: 'power2.out',
        }, 2.0);
      }

      // 7. Mission text fades in after ideogram settles
      if (missionText) {
        ideoTl.to(missionText, {
          opacity: 1,
          y: 0,
          duration: 0.8,
          ease: 'power2.out',
        }, 2.4);
      }

      // 8. Persistent slow ember pulse on settled ideogram
      ideoTl.add(() => {
        const breathe = gsap.to(ideogram, {
          textShadow: '0 0 28px rgba(212, 175, 55, 0.45), 0 0 60px rgba(196, 30, 58, 0.2), 0 0 12px rgba(212, 175, 55, 0.3)',
          duration: 2.5,
          ease: 'sine.inOut',
          repeat: -1,
          yoyo: true,
        });
        // Store references so FireHoverGlobal can pause/resume breathing
        (ideogram as any).__breatheTween = breathe;
        (ideogram as any).__restingShadow = '0 0 20px rgba(212, 175, 55, 0.35), 0 0 50px rgba(196, 30, 58, 0.15), 0 0 8px rgba(212, 175, 55, 0.2)';
      }, 3.2);
    }

    // ─── CTA section ────────────────────────────────────────────────
    const ctaSection = document.querySelector('[data-gsap="cta-section"]');
    if (ctaSection) {
      const ctaInner = ctaSection.querySelector(':scope > div');
      if (ctaInner) {
        gsap.set(ctaInner.children, { opacity: 0, y: 20 });
        gsap.to(ctaInner.children, {
          opacity: 1,
          y: 0,
          duration: 0.6,
          ease: 'power2.out',
          stagger: 0.12,
          scrollTrigger: {
            trigger: ctaSection,
            start: 'top 85%',
            toggleActions: 'play none none none',
          },
        });
      }
    }
</script>
