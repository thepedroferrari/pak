---
// Script-only component — renders no HTML, just client-side animation logic.
// Imported at the bottom of instructor pages to layer GSAP animations on top of static content.
---

<script>
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  // Reusable ember glow values (matching LineageAnimation palette)
  const EMBER_PEAK = '0 0 30px rgba(196, 30, 58, 0.9), 0 0 60px rgba(139, 0, 0, 0.6), 0 0 15px rgba(212, 175, 55, 0.7), 0 0 100px rgba(196, 30, 58, 0.3)';
  const EMBER_WARM = '0 0 12px rgba(212, 175, 55, 0.3), 0 0 30px rgba(196, 30, 58, 0.12), 0 0 4px rgba(212, 175, 55, 0.15)';
  const EMBER_NONE = '0 0 0px transparent';
  const EMBER_INTENSE = '0 0 50px rgba(196, 30, 58, 1), 0 0 100px rgba(139, 0, 0, 0.7), 0 0 25px rgba(212, 175, 55, 0.8), 0 0 150px rgba(196, 30, 58, 0.4), 0 0 200px rgba(139, 0, 0, 0.15)';

  const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  if (!prefersReducedMotion) {
    // ─── Hero entrance (staggered + ember glow) ─────────────────────
    gsap.set('[data-gsap="hero-zh"]', { opacity: 0, scale: 0.8, textShadow: EMBER_NONE });
    gsap.set('[data-gsap="hero-title"]', { opacity: 0, y: 30, textShadow: EMBER_NONE });
    gsap.set('[data-gsap="hero-divider"]', { opacity: 0, scaleX: 0 });
    gsap.set('[data-gsap="hero-desc"]', { opacity: 0, y: 20 });

    const heroTl = gsap.timeline({ delay: 0.2 });
    heroTl
      .to('[data-gsap="hero-zh"]', { opacity: 1, scale: 1, duration: 1.2, ease: 'power2.out' })
      .to('[data-gsap="hero-zh"]', {
        textShadow: '0 0 60px rgba(196, 30, 58, 0.4), 0 0 120px rgba(139, 0, 0, 0.2)',
        duration: 1.0, ease: 'power2.in',
      }, 0.2)
      .to('[data-gsap="hero-zh"]', {
        textShadow: '0 0 20px rgba(196, 30, 58, 0.08), 0 0 60px rgba(139, 0, 0, 0.04)',
        duration: 1.5, ease: 'power2.out',
      }, 1.2)
      .to('[data-gsap="hero-title"]', { opacity: 1, y: 0, duration: 0.8, ease: 'power3.out' }, 0.7)
      .to('[data-gsap="hero-title"]', {
        textShadow: EMBER_PEAK,
        duration: 0.6, ease: 'power2.in',
      }, 0.8)
      .to('[data-gsap="hero-title"]', {
        textShadow: EMBER_WARM,
        duration: 1.2, ease: 'power2.out',
      }, 1.4)
      .to('[data-gsap="hero-divider"]', { opacity: 1, scaleX: 1, duration: 0.6, ease: 'power2.out' }, 1.1)
      .to('[data-gsap="hero-desc"]', { opacity: 1, y: 0, duration: 0.6, ease: 'power2.out' }, 1.3);

    // ─── Spotlight ideograms — burning clip-path reveal + double-pulse fire ──
    document.querySelectorAll('[data-gsap="spotlight-section"]').forEach((section) => {
      const ideogram = section.querySelector('[data-gsap="spotlight-ideogram"]');
      const glow = section.querySelector('[data-gsap="spotlight-glow"]');
      const content = section.querySelector('[data-gsap="spotlight-content"]');

      if (ideogram) {
        gsap.set(ideogram, { clipPath: 'inset(100% 0 0 0)', textShadow: EMBER_NONE });
        if (glow) gsap.set(glow, { opacity: 0, scale: 0.3 });
        if (content) gsap.set(content, { opacity: 0, x: 40 });

        const tl = gsap.timeline({
          scrollTrigger: {
            trigger: section,
            start: 'top 75%',
            toggleActions: 'play none none none',
          },
        });

        // 1. Background glow expands
        if (glow) {
          tl.to(glow, { opacity: 0.8, scale: 1.1, duration: 1.4, ease: 'power2.out' }, 0);
        }

        // 2. Character burns in via clip-path
        tl.to(ideogram, { clipPath: 'inset(0% 0 0 0)', duration: 2.0, ease: 'power1.inOut' }, 0.1);

        // 3. First ember wave
        tl.to(ideogram, { textShadow: EMBER_INTENSE, duration: 0.8, ease: 'power2.in' }, 0.3);

        // 4. Brief cool-down then second flare (double-pulse)
        tl.to(ideogram, {
          textShadow: '0 0 30px rgba(196, 30, 58, 0.5), 0 0 60px rgba(139, 0, 0, 0.3), 0 0 15px rgba(212, 175, 55, 0.4)',
          duration: 0.4, ease: 'power2.out',
        }, 1.1);
        tl.to(ideogram, { textShadow: EMBER_INTENSE, duration: 0.5, ease: 'power2.in' }, 1.5);

        // 5. Settle to warm persistent glow
        tl.to(ideogram, {
          textShadow: '0 0 20px rgba(212, 175, 55, 0.35), 0 0 50px rgba(196, 30, 58, 0.15), 0 0 8px rgba(212, 175, 55, 0.2)',
          duration: 1.2, ease: 'power2.out',
        }, 2.0);

        // 6. Background glow settles
        if (glow) {
          tl.to(glow, { opacity: 0.3, scale: 1, duration: 1.2, ease: 'power2.out' }, 2.0);
        }

        // 7. Content slides in from side
        if (content) {
          tl.to(content, { opacity: 1, x: 0, duration: 0.8, ease: 'power2.out' }, 0.6);
        }

        // 8. Persistent slow ember pulse
        tl.add(() => {
          gsap.to(ideogram, {
            textShadow: '0 0 28px rgba(212, 175, 55, 0.45), 0 0 60px rgba(196, 30, 58, 0.2), 0 0 12px rgba(212, 175, 55, 0.3)',
            duration: 2.5,
            ease: 'sine.inOut',
            repeat: -1,
            yoyo: true,
          });
        }, 3.2);
      }
    });

    // ─── Section Chinese headings — burning clip-path reveal ────────
    document.querySelectorAll('[data-gsap="section-zh"]').forEach((el) => {
      gsap.set(el, { clipPath: 'inset(100% 0 0 0)', textShadow: EMBER_NONE, opacity: 1 });

      const tl = gsap.timeline({
        scrollTrigger: {
          trigger: el,
          start: 'top 90%',
          toggleActions: 'play none none none',
        },
      });

      tl.to(el, { clipPath: 'inset(0% 0 0 0)', duration: 1.0, ease: 'power1.inOut' }, 0);
      tl.to(el, {
        textShadow: '0 0 25px rgba(196, 30, 58, 0.7), 0 0 50px rgba(139, 0, 0, 0.4), 0 0 12px rgba(212, 175, 55, 0.5)',
        duration: 0.5, ease: 'power2.in',
      }, 0.2);
      tl.to(el, {
        textShadow: '0 0 8px rgba(212, 175, 55, 0.15), 0 0 20px rgba(196, 30, 58, 0.06)',
        duration: 0.8, ease: 'power2.out',
      }, 0.7);
    });

    // ─── Grid cards: stagger in with bounce ─────────────────────────
    document.querySelectorAll('[data-gsap="instructor-grid"]').forEach((grid) => {
      const cards = grid.querySelectorAll('[data-gsap="instructor-card"]');
      if (cards.length === 0) return;

      gsap.set(cards, { opacity: 0, y: 40, scale: 0.9 });

      gsap.to(cards, {
        opacity: 1,
        y: 0,
        scale: 1,
        duration: 0.5,
        ease: 'back.out(1.4)',
        stagger: 0.12,
        scrollTrigger: {
          trigger: grid,
          start: 'top 85%',
          toggleActions: 'play none none none',
        },
      });
    });

    // ─── Card hover fire effects (mouse-only) ──────────────────────
    if (window.matchMedia('(pointer: fine)').matches) {
      const fireConfigs: Record<string, { imgShadow: string; textShadow: string; scale: number }> = {
        grandmaster: {
          imgShadow: '0 0 40px rgba(212, 175, 55, 0.8), 0 0 80px rgba(196, 30, 58, 0.5), 0 0 20px rgba(212, 175, 55, 0.6)',
          textShadow: '0 0 15px rgba(212, 175, 55, 0.6), 0 0 30px rgba(196, 30, 58, 0.3)',
          scale: 1.08,
        },
        founder: {
          imgShadow: '0 0 35px rgba(196, 30, 58, 0.7), 0 0 70px rgba(139, 0, 0, 0.45), 0 0 18px rgba(212, 175, 55, 0.5)',
          textShadow: '0 0 12px rgba(196, 30, 58, 0.5), 0 0 25px rgba(139, 0, 0, 0.2)',
          scale: 1.07,
        },
        master: {
          imgShadow: '0 0 30px rgba(196, 30, 58, 0.7), 0 0 60px rgba(139, 0, 0, 0.4), 0 0 15px rgba(212, 175, 55, 0.4)',
          textShadow: '0 0 12px rgba(196, 30, 58, 0.5), 0 0 25px rgba(139, 0, 0, 0.2)',
          scale: 1.06,
        },
        sifu: {
          imgShadow: '0 0 20px rgba(196, 30, 58, 0.5), 0 0 40px rgba(139, 0, 0, 0.25), 0 0 10px rgba(212, 175, 55, 0.2)',
          textShadow: '0 0 8px rgba(196, 30, 58, 0.3), 0 0 15px rgba(139, 0, 0, 0.12)',
          scale: 1.05,
        },
        sipak: {
          imgShadow: '0 0 12px rgba(196, 30, 58, 0.3), 0 0 25px rgba(139, 0, 0, 0.15), 0 0 6px rgba(212, 175, 55, 0.1)',
          textShadow: '0 0 6px rgba(196, 30, 58, 0.2), 0 0 10px rgba(139, 0, 0, 0.08)',
          scale: 1.04,
        },
      };

      document.querySelectorAll('[data-gsap="instructor-card"]').forEach((card) => {
        const tier = (card as HTMLElement).dataset.tier || 'sipak';
        const config = fireConfigs[tier] || fireConfigs.sipak;
        const img = card.querySelector('img');
        const nameEl = card.querySelector('[data-gsap="card-name"]');

        card.addEventListener('mouseenter', () => {
          if (img) gsap.to(img, { boxShadow: config.imgShadow, duration: 0.3, ease: 'power2.out' });
          if (nameEl) gsap.to(nameEl, { textShadow: config.textShadow, duration: 0.3, ease: 'power2.out' });
          gsap.to(card, { scale: config.scale, duration: 0.3, ease: 'power2.out' });
        });

        card.addEventListener('mouseleave', () => {
          if (img) gsap.to(img, { boxShadow: EMBER_NONE, duration: 0.4, ease: 'power2.out' });
          if (nameEl) gsap.to(nameEl, { textShadow: EMBER_NONE, duration: 0.4, ease: 'power2.out' });
          gsap.to(card, { scale: 1, duration: 0.4, ease: 'power2.out' });
        });
      });
    }

    // ─── Detail page photo — scale bounce + ember ring flash ────────
    const detailPhoto = document.querySelector('[data-gsap="detail-photo"]');
    if (detailPhoto) {
      gsap.set(detailPhoto, { opacity: 0, scale: 0.9 });

      const detailTl = gsap.timeline({ delay: 0.3 });
      detailTl
        .to(detailPhoto, { opacity: 1, scale: 1, duration: 0.7, ease: 'back.out(1.5)' })
        .to(detailPhoto, {
          boxShadow: '0 0 40px rgba(196, 30, 58, 0.6), 0 0 80px rgba(139, 0, 0, 0.3), 0 0 20px rgba(212, 175, 55, 0.4)',
          duration: 0.5, ease: 'power2.in',
        }, '-=0.2')
        .to(detailPhoto, {
          boxShadow: '0 0 15px rgba(212, 175, 55, 0.15), 0 0 30px rgba(196, 30, 58, 0.06)',
          duration: 0.8, ease: 'power2.out',
        });
    }

    // ─── Detail page bio panel ──────────────────────────────────────
    const bioPanel = document.querySelector('[data-gsap="bio-panel"]');
    if (bioPanel) {
      gsap.set(bioPanel, { opacity: 0, y: 30 });
      gsap.to(bioPanel, {
        opacity: 1, y: 0, duration: 0.7, ease: 'power2.out',
        scrollTrigger: { trigger: bioPanel, start: 'top 88%', toggleActions: 'play none none none' },
      });
    }

    // ─── Detail page gallery items ──────────────────────────────────
    const galleryGrid = document.querySelector('[data-gsap="gallery-grid"]');
    if (galleryGrid) {
      const items = galleryGrid.querySelectorAll('[data-gsap="gallery-item"]');
      if (items.length > 0) {
        gsap.set(items, { opacity: 0, y: 30, scale: 0.95 });
        gsap.to(items, {
          opacity: 1, y: 0, scale: 1,
          duration: 0.5, ease: 'back.out(1.2)', stagger: 0.08,
          scrollTrigger: { trigger: galleryGrid, start: 'top 85%', toggleActions: 'play none none none' },
        });
      }
    }

    // ─── CTA section fade ───────────────────────────────────────────
    const ctaSection = document.querySelector('[data-gsap="cta-section"]');
    if (ctaSection) {
      const ctaInner = ctaSection.querySelector(':scope > div');
      if (ctaInner) {
        gsap.set(ctaInner.children, { opacity: 0, y: 20 });
        gsap.to(ctaInner.children, {
          opacity: 1, y: 0, duration: 0.6, ease: 'power2.out', stagger: 0.12,
          scrollTrigger: { trigger: ctaSection, start: 'top 85%', toggleActions: 'play none none none' },
        });
      }
    }
  } else {
    // ─── Reduced motion: show ideograms statically ───────────────
    document.querySelectorAll('[data-gsap="spotlight-ideogram"]').forEach((el) => {
      (el as HTMLElement).style.clipPath = 'inset(0% 0 0 0)';
    });
    document.querySelectorAll('[data-gsap="section-zh"]').forEach((el) => {
      (el as HTMLElement).style.clipPath = 'inset(0% 0 0 0)';
    });
  }
</script>
